<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Something Pithy about Data" />
  	<meta property="og:site_name" content="Something Pithy about Data" />
  	<meta property="og:url" content="https://data-life.github.io/" />
    
    
    <meta property="og:type" content="website" />
    

  <title>
     Something Pithy about Data
  </title>

    <meta name="description" content="Experiences using AWS Big Data services" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://data-life.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://data-life.github.io/images/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="https://data-life.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
      
        <link href="https://data-life.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Something Pithy about Data" />
      
    
    <meta name="generator" content="Hugo 0.56.3" />

    <link rel="canonical" href="https://data-life.github.io/" />

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-82435011-1', 'auto');
      ga('send', 'pageview');

    </script>
    
<div id="particles-js"></div>
<script src="http://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://data-life.github.io/js/particles.js"></script>   
</head>
<body class="nav-closed">

  


 <div class="site-wrapper">



<header class="main-header no-cover">

    

    <nav class="main-nav overlay clearfix">
        
        
    </nav>
<div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">
              <a class="btn-bootstrap-2 title-scroll" href="#content">Something Pithy about Data</a>
          </h1>
          <h2 class="page-description">Experiences using AWS Big Data services</h2>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

<main id="content" class="content" role="main">

    

    <div class="extra-pagination inner">
        <nav class="pagination" role="navigation">
	
	<span class="page-number">Page 1 of 2</span>
	
	    <a class="older-posts" href="https://data-life.github.io/page/2/">Older Posts &rarr;</a>
	
</nav>

    </div>

    
        

<article class="post post">
    <header class="post-header">
        <h2 class="post-title"><a href="https://data-life.github.io/post/elasticsearch/splitbrain/">The Split Brain Problem</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<h2 id="the-problem">The Problem</h2>

<p>Consider a two node cluster that contains one index with a replication factor of one. This means that each shard of data in the index resides on one node and is replicated to the other node. One of these nodes is elected the master of the cluster to handle administrative tasks and it holds the primary shard for the index. What happens when there is a break in communication between the two nodes for whatever reason? Both nodes will think that the other node has gone off line. In the case of the original master, it will carry on life as normal, trying to assign replica shards as soon as another node comes on line. In the case of the other node, it will now promote itself to be a master and promote its replica shards to be primary shards. Any requests that come in at this point will result in the shards diverging from each other. Once communication is restored or you decide to manually intervene, you now have two masters that both potentially have some of the most up to date information. This makes the resulting data set very difficult to deal with, if it&rsquo;s at all possible, without ingesting the data again.</p>

<h2 id="the-solution">The Solution</h2>

<p>The easiest solution is to have an odd number of nodes in your cluster. This ensures that if there is a break in communication between two groups of nodes (No matter the distribution of numbers), you will always have a quorum for who the true master is. While this method goes a long way towards ensuring the resilience</p>

          </section>
      </p>
      
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/elasticsearch/">#Elasticsearch</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/split-brain/">#Split Brain</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/nodes/">#Nodes</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/architecture/">#Architecture</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/troubleshooting/">#Troubleshooting</a></span>
         

    </section>
    <footer class="post-meta">
        
        
            markdawe
        
        on
            
                <a href="https://data-life.github.io/tags/elasticsearch/">#Elasticsearch</a>,
            
                <a href="https://data-life.github.io/tags/split-brain/">#Split Brain</a>,
            
                <a href="https://data-life.github.io/tags/nodes/">#Nodes</a>,
            
                <a href="https://data-life.github.io/tags/architecture/">#Architecture</a>,
            
                <a href="https://data-life.github.io/tags/troubleshooting/">#Troubleshooting</a>,
            
        
        <time class="post-date" datetime="2016-10-04T12:03:44Z">
            4 Oct 2016
        </time>
    </footer>
</article>

    
        

<article class="post post">
    <header class="post-header">
        <h2 class="post-title"><a href="https://data-life.github.io/post/elasticsearch/metricsandmeaning/">Elasticsearch cluster metrics and what they mean</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            
          </section>
      </p>
      
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/elasticsearch/">#Elasticsearch</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/cloudwatch/">#Cloudwatch</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/metrics/">#Metrics</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/status/">#Status</a></span>
         

    </section>
    <footer class="post-meta">
        
        
            markdawe
        
        on
            
                <a href="https://data-life.github.io/tags/elasticsearch/">#Elasticsearch</a>,
            
                <a href="https://data-life.github.io/tags/cloudwatch/">#Cloudwatch</a>,
            
                <a href="https://data-life.github.io/tags/metrics/">#Metrics</a>,
            
                <a href="https://data-life.github.io/tags/status/">#Status</a>,
            
        
        <time class="post-date" datetime="2016-08-25T08:22:55Z">
            25 Aug 2016
        </time>
    </footer>
</article>

    
        

<article class="post post">
    <header class="post-header">
        <h2 class="post-title"><a href="https://data-life.github.io/post/emr/predictableipforyourmaster/">Predictable IP For Your Master Node</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<h2 id="the-problem">The Problem</h2>

<p>Sometimes you are looking to be able to specify both the public and the private IP for an EMR cluster when it launches. This allows you to not have to change any existing infrastructure, while still being able to decommission an EMR cluster whenever it is needed and provision a new one. Currently you are able to attach an EIP to the master instance, but this does not solve the issue for private clusters and is cumbersome if clusters are constantly being provisioned/decommissioned.</p>

<h2 id="the-solution">The Solution</h2>

<p>The easiest way to have a predictable private IP for a new EMR cluster is to have an ENI set up ahead of time. This will allow the you to set both the public IP with an EIP as well as the private IP associated with the ENI. As long as this ENI is in the same subnet as where the cluster will be launched, then when the cluster is launched you will be able to attach the ENI to the master. From there, because EMR does not necessarily listen on 0.0.0.0 for its services, you are able to use iptables to forward all traffic from the ENI the you just attached to the original ENI of the master. When a cluster is terminated, the ENI will become available again to be associated with another cluster if need be.</p>

<p>This can be achieved by running a step on the cluster at any point in its life cycle. The only thing preparation that would need to be done ahead of time would be the setup of the ENI as well as adding the following permissions to the EMR_EC2_DefaultRole role:
ec2:AttachNetworkInterface</p>

<p>This will enable the master to use the AWS CLI to attach the ENI to itself.</p>

<p>This has been tested on EMR 4.4.0, but should work in any version of EMR. Due to the way that the forwarding works, you are able to access all services on the master on all ports from either the new ENI or the old ENI, so no functionality should be lost with this approach.</p>

<p>This step will fail if the ENI unable to be attached so an appropriate Action on failure should be selected based on use case. The step itself is a fairly simple one, only requiring 1 line to attach the ENI and then 3 lines to set up traffic forwarding:</p>

<pre><code>#!/bin/bash
aws ec2 attach-network-interface --network-interface-id &lt;Your ENI ID goes here&gt; --instance-id $(curl -s http://169.254.169.254/latest/meta-data/instance-id ) --device-index 1
sudo sysctl -w net.ipv4.conf.all.forwarding=1
sudo iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT
</code></pre>

          </section>
      </p>
      
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/emr/">#EMR</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/eni/">#ENI</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/step/">#Step</a></span>
         

    </section>
    <footer class="post-meta">
        
        
            markdawe
        
        on
            
                <a href="https://data-life.github.io/tags/emr/">#EMR</a>,
            
                <a href="https://data-life.github.io/tags/eni/">#ENI</a>,
            
                <a href="https://data-life.github.io/tags/step/">#Step</a>,
            
        
        <time class="post-date" datetime="2016-08-24T12:42:42Z">
            24 Aug 2016
        </time>
    </footer>
</article>

    
        

<article class="post post">
    <header class="post-header">
        <h2 class="post-title"><a href="https://data-life.github.io/post/datapipeline/supportedemrnodetypes/">Supported EMRCluster Node Types</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<h2 id="the-problem">The Problem</h2>

<p>Data Pipeline supports instances that use Instance Storage, not EBS volumes. EMR clusters support both. These two worlds collide when you try to use Data Pipeline to launch an EMR cluster since your nodes will need to support instance storage.</p>

<h2 id="the-solution">The Solution</h2>

<p>Since this can be a mission to figure out, the following are instance types categorized according to optimizations that have instance storage and are supported by EMR. These are all available to launch in US-East-1, so if you are looking to launch in another region, make sure that it supports the instance type you are looking for:</p>

<p><strong>Compute Optimized (Previous Generation)</strong></p>

<ul>
<li>c1.medium</li>
<li>c1.xlarge</li>
<li>cc2.8xlarge</li>
</ul>

<p><strong>Compute Optimized</strong></p>

<ul>
<li>c3.xlarge</li>
<li>c3.2xlarge</li>
<li>c3.4xlarge</li>
<li>c3.8xlarge</li>
</ul>

<p><strong>GPU Instances</strong></p>

<ul>
<li>cg1.4xlarge</li>
<li>g2.2xlarge</li>
</ul>

<p><strong>Memory Optimized (Previous Generation)</strong></p>

<ul>
<li>cr1.8xlarge</li>
<li>m2.xlarge</li>
<li>m2.2xlarge</li>
<li>m2.4xlarge</li>
</ul>

<p><strong>Memory Optimized</strong></p>

<ul>
<li>r3.xlarge</li>
<li>r3.2xlarge</li>
<li>r3.4xlarge</li>
<li>r3.8xlarge</li>
</ul>

<p><strong>Storage Optimized</strong></p>

<ul>
<li>d2.xlarge</li>
<li>d2.2xlarge</li>
<li>d2.4xlarge</li>
<li>hs1.8xlarge</li>
<li>i2.xlarge</li>
<li>i2.2xlarge</li>
<li>i2.4xlarge</li>
<li>i2.8xlarge</li>
</ul>

<p><strong>Storage Optimized (Previous generation)</strong></p>

<ul>
<li>hi1.4xlarge</li>
</ul>

<p><strong>General Purpose (Previous generation)</strong></p>

<ul>
<li>m1.medium</li>
<li>m1.large</li>
<li>m1.xlarge</li>
</ul>

<p><strong>General Purpose</strong></p>

<ul>
<li>m3.xlarge</li>
<li>m3.2xlarge</li>
</ul>

          </section>
      </p>
      
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/data-pipeline/">#Data Pipeline</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/emr/">#EMR</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/instance-type/">#Instance Type</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/instance-storage/">#Instance Storage</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/emrcluster/">#EMRCluster</a></span>
         

    </section>
    <footer class="post-meta">
        
        
            markdawe
        
        on
            
                <a href="https://data-life.github.io/tags/data-pipeline/">#Data Pipeline</a>,
            
                <a href="https://data-life.github.io/tags/emr/">#EMR</a>,
            
                <a href="https://data-life.github.io/tags/instance-type/">#Instance Type</a>,
            
                <a href="https://data-life.github.io/tags/instance-storage/">#Instance Storage</a>,
            
                <a href="https://data-life.github.io/tags/emrcluster/">#EMRCluster</a>,
            
        
        <time class="post-date" datetime="2016-08-20T11:07:59Z">
            20 Aug 2016
        </time>
    </footer>
</article>

    
        

<article class="post post">
    <header class="post-header">
        <h2 class="post-title"><a href="https://data-life.github.io/post/scripting/powershellbestspotinstance/">Use Powershell to find the best Spot Instance</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<h1 id="how-do-you-find-the-best-value-for-money-spot-instance">How do you find the best value for money Spot Instance</h1>

<p>Sometimes you are just looking for the cheapest way to do something in AWS. Initially you look at spot instances, but realistically you need a monster machine to achieve what you are looking to do. Either your task is CPU or Memory intensive and so you look at using spot prices for one of the larger AWS instances. Assuming this task you are looking to achieve can be run using a cluster on EC2 or one that supports spot instances, it turns out that the best value for money is not always the largest instance types.</p>

<h2 id="sometimes-an-army-of-small-instances-can-achieve-the-job">Sometimes an army of small instances can achieve the job</h2>

<p>If you are able to launch 100 instances with 4GB of RAM for the same price as 10 instances with 32GB of RAM, it seems like a simple solution which instance type to choose. Most people are not checking on the spot price of every instance type that can be launched and comparing the value for money of each. As a consequence of using more clustering software lately, I created the script below in powershell. It will pull every instance type that can be launched courtesy of <a href="http://www.ec2instances.info">http://www.ec2instances.info</a>. It will then take that information and loop through all instance types, checking for the cheapest region to launch an instance in, as well as the cheapest availability zone in your account. Keep in mind that AZs are mapped differently <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-availability-zones">for each account</a> so make sure to run this script with the appropriate credentials. Once it has a list of the cheapest price you can launch an instance for, it will then compare the price per gig of each instance type and price per <a href="https://aws.amazon.com/ec2/faqs/#What_is_an_EC2_Compute_Unit_and_why_did_you_introduce_it">ECU</a> and return the best value for money option for each. Since these are based on spot prices, you are best off running this before you launch a cluster, not running it once and assuming the same values will always apply. For debugging purposes, it currently also gives an output for all instances with returned prices, but this value can be commented out.</p>

<h2 id="the-script-itself">The script itself</h2>

<pre><code>
#==========================================
# Functions
#==========================================

function FindBestInstanceSpotPriceByType ($InstanceType)
{
    #-------------------------------------------------------
    # Get best spot price in all regions for instance type
    #-------------------------------------------------------
    
    # Initialise clean array for prices
    $PricesByRegion = @()
    $Regions = @()

    Write-Host &quot;Checking for:&quot; $InstanceType.instance_type

    # Get region where instance type is supported
    Foreach ($InstanceRegion in $InstanceType.pricing)
    {
        $Regions += $($InstanceRegion | Get-Member -MemberType *Property).Name
    }

    # Loop through supported regions to get best spot prices for instance type
    Foreach ($Region in $Regions)
    {
        # Grab cheapest spot price in each region by instance type specified
        $PriceByRegion = Get-EC2SpotPriceHistory -Region $Region.Region -InstanceType $InstanceType.instance_type -StartTime (Get-Date -Format s)| Sort-Object -Property Price | Select-Object -First 1
        $PricesByRegion += $PriceByRegion 
    }

    # Find the cheapest spot price over all regions
    $Cheapest = $PricesByRegion | Sort-Object -Property Price | Select-Object -First 1
    $Cheapest | Sort-Object -Property ECU

    # Check if Spot prices exist in any region
    
    If ($Cheapest)
    {
        # Work out price per gig of memory
        $PricePerGig = ($Cheapest.price / $InstanceType.memory)
    
        # If CPU not burstable work out price per ECU
        if ($InstanceType.ECU -ne &quot;variable&quot;)        {
            $PricePerCore = ($Cheapest.price / $InstanceType.ECU)
        }
        else
        {
            $PricePerCore = ($Cheapest.price / $InstanceType.vCPU)
            
        }

        # Add useful information to returning variable
        $Cheapest | Add-Member -type NoteProperty -name PricePerGig -value $PricePerGig
        $Cheapest | Add-Member -type NoteProperty -name PricePerECU -value $PricePerCore
        $Cheapest | Add-Member -type NoteProperty -name NetworkPerformance -value $InstanceType.network_performance
        $Cheapest | Add-Member -type NoteProperty -name Storage -value $InstanceType.storage
        $Cheapest | Add-Member -type NoteProperty -name ECU -value $InstanceType.ECU
        $Cheapest | Add-Member -type NoteProperty -name vCPU -value $InstanceType.vCPU
        $Cheapest | Add-Member -type NoteProperty -name Memory -value $InstanceType.memory

        # Return if Value Exists return best spot price
        return $Cheapest
    }
}

function BestPerGigPrice ($BestSpotPrices)
{
    #----------------------------------------------------------
    # Take array of best prices and work out best Memory value
    #----------------------------------------------------------

    $BestPerGig = $BestSpotPrices | Sort-Object -Property PricePerGig | Select-Object -First 1
    return $BestPerGig
}

function BestPerECUPrice ($BestSpotPrices)
{
    #--------------------------------------------------------
    # Take array of best prices and work out best ECU value
    #--------------------------------------------------------

    $PricePerECU = $BestSpotPrices | Sort-Object -Property PricePerECU | Select-Object -First 1
    return $PricePerECU
}

#==========================================
# Main Code
#==========================================

# For script benchmarking
Get-Date

# Pull instance types from EC2Instances.info
$InstanceTypes = (Invoke-WebRequest -Uri &quot;https://raw.githubusercontent.com/powdahound/ec2instances.info/master/www/instances.json&quot;) | ConvertFrom-Json

# Array of best spot prices
$BestSpotPrices = @()find


# Loop through instance types
Foreach ($InstanceType in $InstanceTypes)
{
    $BestSpotPrices += (FindBestInstanceSpotPriceByType $InstanceType)
}

# Summary
Write-Host &quot;Summary of all instances:&quot;
$BestSpotPrices
Write-Host &quot;Best Spot instance for CPU (T Series measured with vCPUs not ECUs):&quot;
BestPerECUPrice $BestSpotPrices
Write-Host &quot;Best Spot instance for Memory:&quot;
BestPerGigPrice $BestSpotPrices


# For script benchmarking
Get-Date

</code></pre>

<h2 id="a-sample-output-for-best-ecu-and-ram">A sample output for best ECU and RAM</h2>

<pre><code>Best Spot instance for CPU (T Series measured with vCPUs not ECUs):

PricePerGig        : 0.0046666666666666666666666667
PricePerECU        : 0.0021875
NetworkPerformance : Moderate
Storage            : 
ECU                : 8.0
vCPU               : 2
Memory             : 3.75
AvailabilityZone   : us-west-1b
InstanceType       : c4.large
Price              : 0.017500
ProductDescription : Linux/UNIX
Timestamp          : 8/10/2016 2:19:06 PM

Best Spot instance for Memory:

PricePerGig        : 0.001
PricePerECU        : 0.0026307692307692307692307692
NetworkPerformance : Moderate
Storage            : @{ssd=False; devices=1; size=420.0}
ECU                : 6.5
vCPU               : 2
Memory             : 17.1
AvailabilityZone   : us-west-1b
InstanceType       : m2.xlarge
Price              : 0.017100
ProductDescription : Linux/UNIX
Timestamp          : 8/10/2016 1:06:26 PM

Wednesday, August 10, 2016 2:31:03 PM
</code></pre>

          </section>
      </p>
      
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/powershell/">#powershell</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/scripting/">#scripting</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/spot-instance/">#spot instance</a></span>
         

    </section>
    <footer class="post-meta">
        
        
            markdawe
        
        on
            
                <a href="https://data-life.github.io/tags/powershell/">#powershell</a>,
            
                <a href="https://data-life.github.io/tags/scripting/">#scripting</a>,
            
                <a href="https://data-life.github.io/tags/spot-instance/">#spot instance</a>,
            
        
        <time class="post-date" datetime="2016-08-10T12:50:26Z">
            10 Aug 2016
        </time>
    </footer>
</article>

    

    <nav class="pagination" role="navigation">
	
	<span class="page-number">Page 1 of 2</span>
	
	    <a class="older-posts" href="https://data-life.github.io/page/2/">Older Posts &rarr;</a>
	
</nav>


</main>

    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Something Pithy about Data</a> All rights reserved - 2016</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://data-life.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="https://data-life.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://data-life.github.io/js/index.js"></script>

</body>
</html>

