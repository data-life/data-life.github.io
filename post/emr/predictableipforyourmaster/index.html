<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Predictable IP For Your Master Node &middot;  Something Pithy about Data" />
  	<meta property="og:site_name" content="Something Pithy about Data" />
  	<meta property="og:url" content="https://data-life.github.io/post/emr/predictableipforyourmaster/" />
    
    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2016-08-24T12:42:42Z" />

    
    <meta property="og:article:tag" content="EMR" />
    
    <meta property="og:article:tag" content="ENI" />
    
    <meta property="og:article:tag" content="Step" />
    
    

  <title>
     Predictable IP For Your Master Node &middot;  Something Pithy about Data
  </title>

    <meta name="description" content="Experiences using AWS Big Data services" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://data-life.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://data-life.github.io/images/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="https://data-life.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="https://data-life.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Something Pithy about Data" />
      
      
    
    <meta name="generator" content="Hugo 0.56.3" />

    <link rel="canonical" href="https://data-life.github.io/post/emr/predictableipforyourmaster/" />

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-82435011-1', 'auto');
      ga('send', 'pageview');

    </script>
    
<div id="particles-js"></div>
<script src="http://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://data-life.github.io/js/particles.js"></script>   
</head>
<body class="nav-closed">

  


 <div class="site-wrapper">




<header class="main-header " style="background-image: url(https://data-life.github.io/)">
    
    <nav class="main-nav overlay clearfix">
        
        
    </nav>
<div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">
              <a class="btn-bootstrap-2" href="#content">Something Pithy about Data</a>
          </h1>
          <h2 class="page-description">Experiences using AWS Big Data services</h2>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

  <main id="content" class="content" role="main">


  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Predictable IP For Your Master Node</h1>
        <section class="post-meta">
        
          <time class="post-date" datetime="2016-08-24T12:42:42Z">
            Aug 24, 2016
          </time>
        
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/emr/">#EMR</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/eni/">#ENI</a></span>
         
          <span class="post-tag small"><a href="https://data-life.github.io/tags/step/">#Step</a></span>
         
        </section>
    </header>
  
    <section class="post-content">
      

<h2 id="the-problem">The Problem</h2>

<p>Sometimes you are looking to be able to specify both the public and the private IP for an EMR cluster when it launches. This allows you to not have to change any existing infrastructure, while still being able to decommission an EMR cluster whenever it is needed and provision a new one. Currently you are able to attach an EIP to the master instance, but this does not solve the issue for private clusters and is cumbersome if clusters are constantly being provisioned/decommissioned.</p>

<h2 id="the-solution">The Solution</h2>

<p>The easiest way to have a predictable private IP for a new EMR cluster is to have an ENI set up ahead of time. This will allow the you to set both the public IP with an EIP as well as the private IP associated with the ENI. As long as this ENI is in the same subnet as where the cluster will be launched, then when the cluster is launched you will be able to attach the ENI to the master. From there, because EMR does not necessarily listen on 0.0.0.0 for its services, you are able to use iptables to forward all traffic from the ENI the you just attached to the original ENI of the master. When a cluster is terminated, the ENI will become available again to be associated with another cluster if need be.</p>

<p>This can be achieved by running a step on the cluster at any point in its life cycle. The only thing preparation that would need to be done ahead of time would be the setup of the ENI as well as adding the following permissions to the EMR_EC2_DefaultRole role:
ec2:AttachNetworkInterface</p>

<p>This will enable the master to use the AWS CLI to attach the ENI to itself.</p>

<p>This has been tested on EMR 4.4.0, but should work in any version of EMR. Due to the way that the forwarding works, you are able to access all services on the master on all ports from either the new ENI or the old ENI, so no functionality should be lost with this approach.</p>

<p>This step will fail if the ENI unable to be attached so an appropriate Action on failure should be selected based on use case. The step itself is a fairly simple one, only requiring 1 line to attach the ENI and then 3 lines to set up traffic forwarding:</p>

<pre><code>#!/bin/bash
aws ec2 attach-network-interface --network-interface-id &lt;Your ENI ID goes here&gt; --instance-id $(curl -s http://169.254.169.254/latest/meta-data/instance-id ) --device-index 1
sudo sysctl -w net.ipv4.conf.all.forwarding=1
sudo iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT
</code></pre>

    </section>


  <footer class="post-footer">


    

    





<section class="author">
  <h4><a href="https://data-life.github.io/">markdawe</a></h4>
  
  <p>my bio</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">South Africa</span>
    <span class="author-link icon-link"><a href="https://data-life.github.io/">https://data-life.github.io/</a></span>
  </div>
</section>



    
    <section class="share">
      <h4>Share this post</h4>
      <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Predictable%20IP%20For%20Your%20Master%20Node&amp;url=https%3a%2f%2fdata-life.github.io%2fpost%2femr%2fpredictableipforyourmaster%2f"
          onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <span class="hidden">Twitter</span>
      </a>
      <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdata-life.github.io%2fpost%2femr%2fpredictableipforyourmaster%2f"
          onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <span class="hidden">Facebook</span>
      </a>
      <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=https%3a%2f%2fdata-life.github.io%2fpost%2femr%2fpredictableipforyourmaster%2f"
         onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
          <span class="hidden">Google+</span>
      </a>
    </section>
    

    
    
    

  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Something Pithy about Data</a> All rights reserved - 2016</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://data-life.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="https://data-life.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://data-life.github.io/js/index.js"></script>

</body>
</html>

